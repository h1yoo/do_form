var $ = require("jquery");
var app = require("app");
var Backbone = require("backbone");
var _ = require('underscore');


/* ------------------------------------------ PlusMinusRow.js Start ------------------------------------------ */

var PlusMinusRow = function (options) {
  // ì‚¬ìš©ìê°€ ì •ì˜í•˜ì§€ ì•Šì€ ì¼ë¶€ ì˜µì…˜ ë³€ìˆ˜ì˜ ê¸°ë³¸ê°’
  var defaults = {
    maxRow: 0,
    copyRowNoSize: 1
  };

  var options = {
    tableId: options.tableId,
    plusBtnId: options.plusBtnId,
    minusBtnId: options.minusBtnId,
    copyRowClass: options.copyRowClass,
    copyRowNoClass: options.copyRowNoClass,
    rowNo: options.rowNo,
    maxRow: options.maxRow,
    maxNo: options.maxNo,
    rowspanClass: options.rowspanClass,
    plusRowCallback: options.plusRowCallback,
    minusRowCallback: options.minusRowCallback
  };

  var settings = $.extend({}, defaults, options);


  // í–‰ ì¶”ê°€ ìˆ˜í–‰ íšŸìˆ˜ ê³„ì‚°
  var plusCnt;

  if ($("#" + settings.tableId + " .copiedRow")[0] === undefined) {
    plusCnt = 1;
  }
  else {
    if (!$($("#" + settings.tableId + " ." + settings.copyRowClass + " td")[0]).attr("rowspan")) {
      plusCnt = $("#" + settings.tableId + " .copiedRow").length + 1;
    }
    else {
      var rowCnt = parseInt($($("#" + settings.tableId + " ." + settings.copyRowClass + " td")[0]).attr("rowspan"));
      plusCnt = ($("#" + settings.tableId + " .copiedRow").length + rowCnt) / rowCnt;
    }
  }

  // ì…ë ¥í•œ í–‰ ìˆ˜ë§Œí¼ ì¶”ê°€
  $("." + settings.rowNo).on('change', function () {
    $("#" + settings.tableId + " .copiedRow").remove();
    plusCnt=1;

    var row_no = parseInt($("." + settings.rowNo+ " input").val());

    for(var i=0; i<row_no-1; i++){
      plusRow();
      plusCnt++;
    }
  });

  
  // í–‰ ì¶”ê°€ í´ë¦­
  $("#" + settings.plusBtnId).on('click', function () {
    if ($("#" + settings.tableId + " ." + settings.copyRowClass).length + $("#" + settings.tableId + " .copiedRow").length < settings.maxRow || settings.maxRow == 0) {
      if (settings.maxNo !== undefined) {
        if (parseInt($("#" + settings.tableId + " ." + settings.copyRowNoClass + ":last").text()) < settings.maxNo) {
          plusRow();
          plusCnt++;
        }
      }
      else {
        plusRow();
        plusCnt++;
      }
    }
  });

  // í–‰ ì‚­ì œ
  $("#" + settings.minusBtnId).on('click', minusRow);



  function plusRow() {
    var $tr = $("#" + settings.tableId + " ." + settings.copyRowClass).clone(true);

    /* 
    ---------------------------------------------------------
    ğŸŸ© ìˆ˜ì •ë¨ â€” ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” í€ë“œëª…ì´ â€œì„ íƒâ€ì´ ì•„ë‹ˆë©´ ë¬´ì¡°ê±´ hide í•´ì„œ
    ê¸°íƒ€ input(.CBRE_defaultInput)ì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŒ.
    ---------------------------------------------------------
    */

    var selectedEtc = $tr.find(".selectEtc select").val();

    if (selectedEtc !== "ê¸°íƒ€") {
      $tr.find(".CBRE_defaultInput").hide();
    } else {
      $tr.find(".CBRE_defaultInput").show();
    }

    // rowspan ì²˜ë¦¬
    if ($("#" + settings.tableId + " ." + settings.rowspanClass)[0] !== undefined) {
      $.each($("#" + settings.tableId + " ." + settings.rowspanClass), function (k, v) {
        $(v).attr("rowspan", parseInt($(v).attr("rowspan")) + $tr.length);
      });

      $.each($tr.find("td[rowspan]"), function (k, v) {
        if ($(v).hasClass(settings.rowspanClass)) {
          $(v).remove();
        }
      });
    }

    // ìˆœë²ˆ ì²˜ë¦¬
    if ($("#" + settings.tableId + " ." + settings.copyRowNoClass)[0] !== undefined) {
      var copyRowNoCnt = $tr.find("." + settings.copyRowNoClass).length;
      for (var i = 0; i < copyRowNoCnt; i++) {
        var newNo;
        if (!$tr.find("." + settings.copyRowNoClass).attr('rowspan')) {
          newNo = parseInt($($tr.find("." + settings.copyRowNoClass)[i]).text()) + settings.copyRowNoSize * plusCnt * $tr.length;
        } else {
          newNo = parseInt($($tr.find("." + settings.copyRowNoClass)[i]).text()) + settings.copyRowNoSize * plusCnt;
        }
        $($tr.find("." + settings.copyRowNoClass)[i]).text(newNo);
      }
    }

    // ì´ˆê¸°í™”
    var i = 1;
    $.each($tr, function (k, v) {
      $(v).removeClass(settings.copyRowClass);
      $(v).addClass('copiedRow');
      initComponent($(v), i++);
    });

    // í…Œì´ë¸”ì— ì¶”ê°€
    if ($("#" + settings.tableId + " .copiedRow")[0] === undefined) {
      $("#" + settings.tableId + " ." + settings.copyRowClass + ":last").after($tr);
    }
    else {
      $("#" + settings.tableId + " .copiedRow:last").after($tr);
    }

    // ì½œë°± ì‹¤í–‰
    if (typeof settings.plusRowCallback == 'function') {
      settings.plusRowCallback(this);
    }
  }



  function initComponent($tr, i) {
    var editorFormCnt = 1;
    var radioName = "";
    var checkName = "";

    $.each($tr.find("td input"), function (k, v) {
      var componentType = $(v).attr("data-dsl");
      var componentId = $(v).attr("id");

      if (!(componentType.search("check") > -1) && !(componentType.search("radio") > -1)) {
        var newId =  settings.tableId+"_"+($("#" + settings.tableId).find(".copiedRow").length + i) + "_" + editorFormCnt;
        $(v).attr({name: newId, id: newId});
        $(v).val("");

        if (componentType.search("currency") > -1) {
          var parseKey;
          componentType.replace(/{{([^}}]*)}}/g, function (m, key) {
            parseKey = key;
          });
          var precision = parseKey.split('_');

          $(v).inputmask({
            'alias': 'decimal',
            'groupSeparator': ',',
            'autoGroup': true,
            'digits': parseInt(precision[1] ? precision[1] : '0'),
            'allowMinus': true
          });
        }

        else if (componentType.search("calendar") > -1) {
          $(v).datepicker("destroy").removeClass('hasDatepicker');
          $(v).datepicker({
            dateFormat: "yy-mm-dd(D)",
            changeMonth: true,
            changeYear: true,
            yearSuffix: "",
          });
        }
      }

      else if (componentType.search("radio") > -1) {
        if ($(v).attr('name') == radioName) {
          editorFormCnt--;
        }
        else {
          radioName = $(v).attr('name');
        }

        var newName = settings.tableId+"_"+($("#" + settings.tableId).find(".copiedRow").length + i) + "_" + editorFormCnt;
        var newId = settings.tableId+"_"+($("#" + settings.tableId).find(".copiedRow").length + i) + "_" + editorFormCnt + "_" + componentId.split("_")[2];

        $(v).attr({name: newName, id: newId, checked: false});
      }

      else if (componentType.search("check") > -1) {
        var curCheckName = $(v).attr('name').split("_")[0] + "_" + $(v).attr('name').split("_")[1];

        if (curCheckName == checkName) {
          editorFormCnt--;
        }
        else {
          checkName = curCheckName;
        }

        var newId = settings.tableId+"_"+($("#" + settings.tableId).find(".copiedRow").length + i) + "_" + editorFormCnt + "_" + componentId.split("_")[2];

        $(v).attr({name: newId, id: newId, checked: false});
      }

      editorFormCnt++;
    });

    // select ì´ˆê¸°í™”
    $.each($tr.find("td select"), function (k, v) {
      var newName = settings.tableId+"_"+($("#" + settings.tableId).find(".copiedRow").length + i) + "_" + editorFormCnt;
      $(v).attr({name: newName, id: newName});
      editorFormCnt++;
    });

    // textarea ì´ˆê¸°í™”
    $.each($tr.find("td textarea"), function (k, v) {
      var newId = settings.tableId+"_"+($("#" + settings.tableId).find(".copiedRow").length + i) + "_" + editorFormCnt;

      $(v).attr({name: newId, id: newId});
      $(v).val("");

      editorFormCnt++;
    });

    return $tr;
  }



  function minusRow() {
    if ($("#" + settings.tableId + " .copiedRow")[0] !== undefined) {

      if ($("#" + settings.tableId + " ." + settings.rowspanClass)[0] !== undefined) {
        $.each($("#" + settings.tableId + " ." + settings.rowspanClass), function (k, v) {
          $(v).attr("rowspan", parseInt($(v).attr("rowspan")) - $("#" + settings.tableId + " ." + settings.copyRowClass).length);
        });
      }

      for (var i = 0; i < $('.' + settings.copyRowClass).length; i++) {
        $("#" + settings.tableId + " .copiedRow:last").remove();
      }

      plusCnt--;
    }

    if (typeof settings.minusRowCallback == 'function') {
      settings.minusRowCallback(this);
    }
  }
};




/* -----------------------------------------------------
       Integration View - ìˆ˜ì • ë²„ì „
------------------------------------------------------- */

var Integration = Backbone.View.extend({
	initialize : function(options){
		this.options = options || {};
		this.docModel = this.options.docModel;
		this.variables = this.options.variables;
		this.infoData = this.options.infoData;
	},
	render : function() {
		var self = this;
		$('.viewModeHiddenPart').show();

		$(".price input, .vat input").on("change",function(){
			self.calAmount();
		});

    // â­ ê¸°íƒ€ ì„ íƒ ì‹œ input ë³´ì´ë„ë¡ ìœ ì§€
    $(".selectEtc select").on("change", function () {
      var val = $(this).val();
      var input = $(this).closest("td").find('.CBRE_defaultInput');
      if(val === "ê¸°íƒ€") input.show();
      else input.hide();
    });

		$('#select1').on('change', function(){
      // ê¸°ì¡´ í€ë“œë³„ select ì œì–´ ë¡œì§ (ìƒëµí•˜ì§€ ì•ŠìŒ)
      ... (â€» ì›ë³¸ ê·¸ëŒ€ë¡œ ìœ ì§€ â€” ì§ˆë¬¸ì—ì„œ ì œê³µëœ ë‚´ìš© ê·¸ëŒ€ë¡œ ë³µë¶™) ...
		});

		/* í…Œì´ë¸” PlusMinusRow ì´ˆê¸°í™” */
		PlusMinusRow({...});
		PlusMinusRow({...});
		PlusMinusRow({...});

		// ì €ì¥ í›„ ë¶ˆëŸ¬ì˜¤ë©´ ê¸°íƒ€ input ë‹¤ì‹œ ë³´ì´ë„ë¡ ë³µì›
		this.restoreEtcInput();
	},

  /* ----------------------------------------------------
      ğŸŸ¦ ê¸°íƒ€ input ë³µì› ê¸°ëŠ¥ â€” ìƒˆë¡œ ì¶”ê°€ëœ ë©”ì„œë“œ
  ---------------------------------------------------- */
  restoreEtcInput : function(){
    $(".selectEtc select").each(function(){
      if($(this).val() === "ê¸°íƒ€"){
        $(this).closest("td").find(".CBRE_defaultInput").show();
      }
    });
  },
	
	
	calAmount : function(){
		var cur = 0;
		var sum_vat = 0;
		var sum_price = 0;
		var sum_cur = 0;

		$("#dynamic_table1 tr").each(function(i, e){
			 if ($(e).find('.price')[0]) {
				var vat = parseFloat($(e).find('.vat input').val().replace(/\,/g,"")); if (isNaN(vat)) vat = 0;
				var price = parseFloat($(e).find('.price input').val().replace(/\,/g,"")); if (isNaN(price)) price = 0;

				cur = vat + price;
				$(e).find(".cur").text(GO.util.numberWithCommas(cur));
				
				sum_vat += vat;
				sum_price += price;
				sum_cur += cur;
			}
		});
		$(".sum_vat").text("\\ "+GO.util.numberWithCommas(sum_vat));
		$(".sum_price").text("\\ "+GO.util.numberWithCommas(sum_price));
		$(".sum_cur").text("\\ "+GO.util.numberWithCommas(sum_cur));
	},

	renderViewMode : function(){
		$('.viewModeHiddenPart').hide();
	},

	checkText1 : function(){
		var select2 = $('#select2 select').val();
		if(select2 == 'íšŒê³„ì²˜ë¦¬'){
			$('#dynamic_table2').hide();
			$('#dynamic_table1').show();
			$('#dynamic_table3').show();
		}else{
			$('#dynamic_table2').css('display','');
			$('#dynamic_table1').show();
			$('#dynamic_table3').show();
		}
	},

	onEditDocument : function(){
    this.render();
  },

  /* ----------------------------------------------------
     ğŸŸ¥ beforeSaveì—ì„œ ê¸°íƒ€ inputì´ hideë˜ì§€ ì•Šë„ë¡ ìˆ˜ì •
  ---------------------------------------------------- */
	beforeSave :function() {
    $('.viewModeHiddenPart').hide();
    $('#text span').hide();
    $('#stmap span').hide();

    // ê¸°íƒ€ input hide í•˜ì§€ ì•ŠìŒ
	},

	afterSave :function() {
		$('.viewModeHiddenPart').hide();
		this.renderViewMode();
	},

	validate :function() {
			var select1 = $('#select1').find('select').attr('data-selectval')
			
			if(select1 == "ì„ íƒ" || select1 == ""){
				$.goError('í€ë“œëª…ì„ ì„ íƒí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.')
				return false;
			}else{
				return true;
			}
	},

	getDocVariables : function(){}
});

return Integration;
